#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

usage() {
  cat <<'EOF'
Usage: ./run [-n] [-p PORT] [-a ADDRESS]

Options:
  -n           Enable ngrok tunnel
  -p PORT      HTTP server port (default: 8081)
  -a ADDRESS   Bind address for built-in web server (default: 127.0.0.1)
EOF
}

require_cmd() {
  local command_name="$1"
  if ! command -v "${command_name}" >/dev/null 2>&1; then
    echo "Error: '${command_name}' is required but not installed." >&2
    exit 1
  fi
}

is_valid_port() {
  local port="$1"
  [[ "${port}" =~ ^[0-9]+$ ]] || return 1
  (( port >= 1 && port <= 65535 ))
}

use_ngrok=false
port=8081
address="127.0.0.1"
ngrok_pid=""

while getopts ":np:a:h" opt; do
  case "${opt}" in
    n)
      use_ngrok=true
      ;;
    p)
      port="${OPTARG}"
      ;;
    a)
      address="${OPTARG}"
      ;;
    h)
      usage
      exit 0
      ;;
    \?)
      echo "Error: Invalid option '-${OPTARG}'." >&2
      usage
      exit 1
      ;;
    :)
      echo "Error: Option '-${OPTARG}' requires an argument." >&2
      usage
      exit 1
      ;;
  esac
done

if ! is_valid_port "${port}"; then
  echo "Error: Invalid port '${port}'." >&2
  exit 1
fi

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${script_dir}"

require_cmd node
if [[ "${use_ngrok}" == "true" ]]; then
  require_cmd ngrok
fi

cleanup() {
  if [[ -n "${ngrok_pid}" ]] && kill -0 "${ngrok_pid}" >/dev/null 2>&1; then
    kill -TERM "${ngrok_pid}" >/dev/null 2>&1 || true
    wait "${ngrok_pid}" 2>/dev/null || true
  fi
}

trap cleanup EXIT INT TERM

echo "[run] Building library index..."
node build.js

if [[ "${use_ngrok}" == "true" ]]; then
  echo "[run] Starting ngrok tunnel on port ${port}..."
  ngrok http "${port}" &
  ngrok_pid=$!
fi

echo "[run] Starting web server at http://${address}:${port}"
node server.js --host "${address}" --port "${port}"
