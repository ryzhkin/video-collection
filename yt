#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

usage() {
    cat <<'EOF'
Usage: ./yt <url> [url...]

Downloads video(s) as MP4 and rebuilds lib.json afterwards.

Environment variables:
  YT_OUTPUT_DIR Target output directory (default: ./youtube)
  MAX_HEIGHT   Max output height for video stream (default: 480)
EOF
}

require_cmd() {
    local command_name="$1"
    if ! command -v "${command_name}" >/dev/null 2>&1; then
        echo "Error: '${command_name}' is required but not installed." >&2
        exit 1
    fi
}
pick_downloader() {
    if command -v yt-dlp >/dev/null 2>&1; then
        echo "yt-dlp"
        return
    fi
    if command -v youtube-dl >/dev/null 2>&1; then
        echo "youtube-dl"
        return
    fi
    echo ""
}

if [[ $# -lt 1 ]]; then
    usage
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OUTPUT_DIR="${YT_OUTPUT_DIR:-${SCRIPT_DIR}/youtube}"
MAX_HEIGHT="${MAX_HEIGHT:-480}"

if ! [[ "${MAX_HEIGHT}" =~ ^[0-9]+$ ]] || [[ "${MAX_HEIGHT}" -lt 1 ]]; then
    echo "Error: MAX_HEIGHT must be a positive integer." >&2
    exit 1
fi

require_cmd ffmpeg
require_cmd node

DOWNLOADER="$(pick_downloader)"
if [[ -z "${DOWNLOADER}" ]]; then
    echo "Error: neither 'yt-dlp' nor 'youtube-dl' is installed." >&2
    exit 1
fi
if [[ "${DOWNLOADER}" == "youtube-dl" ]]; then
    echo "[yt] Warning: yt-dlp is not installed, falling back to youtube-dl." >&2
fi

mkdir -p "${OUTPUT_DIR}"

FORMAT_SELECTOR="bv*[height<=${MAX_HEIGHT}]+ba/b[height<=${MAX_HEIGHT}]/b"
OUTPUT_TEMPLATE="${OUTPUT_DIR}/%(title).180B [%(id)s].%(ext)s"

echo "[yt] Downloading ${#@} URL(s) to ${OUTPUT_DIR}"
COMMON_ARGS=(
    --newline
    --continue
    --format "${FORMAT_SELECTOR}"
    --output "${OUTPUT_TEMPLATE}"
)

if [[ "${DOWNLOADER}" == "yt-dlp" ]]; then
    EXTRA_ARGS=(
        --merge-output-format mp4
        --remux-video mp4
        --extractor-retries 3
        --retries 3
    )
else
    # youtube-dl compatibility path
    EXTRA_ARGS=(
        --prefer-ffmpeg
        --recode-video mp4
    )
fi

if ! "${DOWNLOADER}" "${COMMON_ARGS[@]}" "${EXTRA_ARGS[@]}" "$@"; then
    if [[ "${DOWNLOADER}" == "youtube-dl" ]]; then
        echo "[yt] Download failed with youtube-dl." >&2
        echo "[yt] youtube-dl is outdated for modern YouTube pages." >&2
        echo "[yt] Install yt-dlp and retry:" >&2
        echo "    brew install yt-dlp" >&2
    fi
    exit 1
fi

echo "[yt] Rebuilding library index..."
(
    cd "${SCRIPT_DIR}"
    node build.js
)

echo "[yt] Done."
